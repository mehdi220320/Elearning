<!-- chapters.component.html -->
<div class="course-header">
  <div class="container">
    <div class="course-header-content">
      <div class="course-breadcrumb">
        <button class="back-btn" (click)="goBackOrFallback()">
          <i class="fas fa-arrow-left"></i>
        </button>
        <a (click)="goBackOrFallback()" style="cursor: pointer" class="breadcrumb-link">{{course.categorie.name}}</a>
        <span class="divider">/</span>
        <span class="current-chapter">{{course.title}}</span>
      </div>
    </div>
    <h1 class="course-title">{{course.title}}</h1>
    <p class="course-description">{{course.description}}</p>
  </div>
</div>

<!-- Progress Bar -->
<div class="container">
  <div class="progress-card">
    <div class="progress-header">
      <div class="progress-title">Votre progression</div>
      <div class="progress-percent">{{ (currentChapitreIndex + 1) / chapitres.length * 100 | number:'1.0-0' }}% complété</div>
    </div>
    <div class="progress-bar">
      <div class="progress-fill" [style.width]="(currentChapitreIndex + 1) / chapitres.length * 100 + '%'"></div>
    </div>
  </div>
</div>

<!-- Chapter Content -->
<div class="container">
  <div class="chapter-grid">
    <!-- Main Content -->
    <main class="chapter-content">
      <!-- Affichage de tous les chapitres -->
      <div  class="chapitre-container">
        <div class="content-card">
          <h1 class="chapitre-title">Chapter {{currentChapitreIndex + 1}} : {{chapitres[currentChapitreIndex].title}}</h1>
          <h3 class="description-title">À propos du chapitre</h3>
          <p class="chapitre-description" *ngIf="chapitres[currentChapitreIndex].description">{{chapitres[currentChapitreIndex].description}}</p>

          <!-- Sections pour chaque chapitre -->
          <div *ngFor="let section of chapitres[currentChapitreIndex].section; let sectionIndex = index" class="section-container">
            <h2 class="section-title">Unité {{sectionIndex+1}}: {{section.title}}</h2>
            <div class="section-description mb-3" *ngIf="section.description">
              <div [innerHTML]="section.description"></div>
            </div>
            <!-- Media Container -->
            <div class="media-container" *ngIf="section.url">
              <div class="video-wrapper">
                <iframe
                  class="video-player"
                  [src]="playVideo(section.url)"
                  frameborder="0"
                  allow="accelerometer;  clipboard-write; encrypted-media; gyroscope; picture-in-picture;"
                  allowfullscreen>
                </iframe>
              </div>
            </div>
            <div *ngIf="section.file?.path && section.file?.contentType?.startsWith('image')"
                 class="responsive-image-container">
              <div class="image-aspect-ratio">
                <img [src]="getImage(section.file!.path)"
                     class="responsive-image"
                     alt="Image preview"
                     loading="lazy">
              </div>
            </div>
            <!-- PDF File Options -->
            <div class="file-options" *ngIf="section.file?.path && section.file?.contentType === 'application/pdf'">
              <div class="file-card">
                <div class="file-icon">
                  <i class="fas fa-file-pdf"></i>
                </div>
                <div class="file-info">
                  <h4>Document PDF</h4>
                  <p>{{section.file.name}} </p>
                </div>
                <div class="file-actions">
                  <a [href]="section.file.path" download class="download-btn">
                    <i class="fas fa-download"></i> Télécharger
                  </a>
                  <button (click)="openPdfViewer(section.file.path,section.file.name)" class="view-btn">
                    <i class="fas fa-eye"></i> Lire
                  </button>
                </div>
              </div>
            </div>

            <!-- PDF Viewer Modal -->

            <!-- Section Description -->

          </div>
        </div>
      </div>

      <!-- Tests Section -->
      <div class="tests-section">
        <div class="tests-header">
          <h2><i class="fas fa-graduation-cap"></i> Tests du cours</h2>
          <p>Évaluez vos connaissances avec ces tests</p>
        </div>

        <div class="tests-list">
          <!-- Test Item -->
          <div class="test-item" *ngFor="let test of testsPagination">
            <div class="test-info">
              <div class="test-header">
                <div class="test-icon">
                  <i class="fas fa-brain"></i>
                </div>
                <h4 class="test-title">{{test.title}}</h4>
              </div>
              <div class="test-details">
                <div class="test-detail">
                  <span class="detail-icon"><i class="fas fa-trophy"></i></span>
                  Score minimum: {{test.passingScore}}%
                </div>
                <div class="test-detail">
                  <span class="detail-icon"><i class="fas fa-question-circle"></i></span>
                  {{test.questions.length}} questions
                </div>
                <div class="test-detail">
                  <span class="detail-icon"><i class="fas fa-clock"></i></span>
                  {{test.timeLimit}} minutes
                </div>
              </div>
              <div *ngIf="lastScore(test.results)!==null" [ngClass]="lastScore(test.results).score<test.passingScore ? 'score-badge-fail': 'score-badge'">
                <i class="fas fa-star"></i>
                Dernier score: {{lastScore(test.results).score}}%
              </div>
            </div>
            <button class="start-test-btn" [routerLink]="'/courses/'+courseId+'/chapters/'+chapitres[currentChapitreIndex]._id+'/test/'+test._id">
              <i class="fas fa-play-circle"></i> Commencer
            </button>
          </div>
        </div>

        <!-- Pagination pour les tests -->
        <div class="pagination" *ngIf="tests.length > 0">
          <button class="pagination-btn" (click)="afficherPlus()" *ngIf="testsPagination.length < tests.length">
            Afficher plus de tests
          </button>
          <div class="pagination-info" *ngIf="testsPagination.length > 0">
            Affichage de {{testsPagination.length}} sur {{tests.length}} tests
          </div>
        </div>

        <div class="no-tests" *ngIf="tests.length === 0">
          <div class="no-tests-illustration">
            <i class="fas fa-file-alt"></i>
          </div>
          <h3>Aucun test disponible pour le moment</h3>
          <p>Revenez plus tard pour évaluer vos connaissances.</p>
        </div>
      </div>
    </main>

    <!-- Sidebar -->
    <aside class="chapter-sidebar">
      <!-- Chapters List -->
      <div class="sidebar-card chapters-card">
        <div class="card-header">
          <h3 class="card-title">Plan du cours</h3>
          <span class="chapter-count">{{chapitres.length}} chapitres</span>
        </div>
        <div class="chapters-list">
          <div class="chapter-list-item"
               *ngFor="let chapitre of chapitres; let i = index"
               [class.active]="i === currentChapitreIndex"
               (click)="goToChapitre(i)">
            <div class="chapter-icon">
              <i class="far" [class.fa-play-circle]="i !== currentChapitreIndex"
                 [class.fas]="i === currentChapitreIndex"
                 [class.fa-check-circle]="i < currentChapitreIndex"></i>
            </div>
            <div class="chapter-info">
              <h4 class="chapter-name">Chapter {{i + 1}}: {{chapitre.title}}</h4>
              <div class="chapter-meta">
                <span class="meta-item"><i class="far fa-list-alt"></i> {{chapitre.section.length}} sections</span>
              </div>
            </div>
            <div class="chapter-status">
              <div class="progress-circle" [style.--progress]="(i < currentChapitreIndex) ? 100 : (i === currentChapitreIndex) ? (currentSectionIndex / chapitre.section.length * 100) : 0">
                <span>{{ (i < currentChapitreIndex) ? 100 : (i === currentChapitreIndex) ? (currentSectionIndex / chapitre.section.length * 100 | number:'1.0-0') : 0 }}%</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Course Info -->
      <div class="sidebar-card course-info-card">
        <h3 class="card-title">Informations du cours</h3>
        <div class="course-info">
          <div class="info-item">
            <i class="fas fa-clock"></i>
            <span>Durée: {{course.duree}}</span>
          </div>
          <div class="info-item">
            <i class="fas fa-chart-line"></i>
            <span>Niveau: {{course.niveau}}</span>
          </div>
          <div class="info-item">
            <i class="fas fa-language"></i>
            <span>Langue: {{course.langue}}</span>
          </div>
          <div class="info-item" *ngIf="course.certificat">
            <i class="fas fa-award"></i>
            <span>Certificat inclus</span>
          </div>
        </div>
      </div>
    </aside>
  </div>
</div>

<div class="container">
  <div class="comments-section">
    <div class="comments-card">
      <div class="comments-header">
        <h3 class="comments-title">
          <i class="far fa-comments"></i> Discussions
        </h3>
<!--        <button class="show-all">Voir tout</button>-->
      </div>

      <div class="comment-form">
        <div class="user-avatar"><img [src]="getImageUser(userPicture)" class="user-avatar"></div>
        <div class="form-group">
          <textarea placeholder="Ajouter un commentaire..." class="comment-input" name="description" [(ngModel)]="description"></textarea>
          <button class="submit-button" (click)="addComment()">Publier</button>
        </div>
      </div>

      <div class="comments-list">
        <div class="comment" *ngFor="let comment of commentsPagination">
          <div class="comment-avatar"><img [src]="getImageUser(comment.user.picture)" class="user-avatar"></div>
          <div class="comment-body">
            <div class="comment-header">
              <span class="comment-author">{{comment.user.firstname +" "+comment.user.lastname}}</span>
              <span class="comment-time">{{ getRelativeTime(comment.createdAt) }}</span>
            </div>
            <div class="comment-text">
              {{comment.description}}
            </div>
            <div class="comment-actions">
              <button class="action-button" *ngIf="!isLike(comment.likes)" (click)="addLike(comment._id)"><i class="far fa-thumbs-up"></i> {{comment.likes.length}}</button>
              <button class="action-button" *ngIf="isLike(comment.likes)" (click)="removeLike(comment._id)"><i class="far fa-thumbs-up" style="color: blue"></i> {{comment.likes.length}}</button>


              <button class="action-button delete-button" *ngIf="isCurrentUser(comment.user._id)" (click)="deleteComment(comment._id)">
                <i class="far fa-trash-alt"></i> Supprimer
              </button>
            </div>
          </div>
        </div>
        <div class="pagination" *ngIf="comments.length > 0">
          <button class="pagination-btn" (click)="VoirAllComment()" *ngIf="!pressedAllComments && commentsPagination.length>2">
            Afficher plus de comments
          </button>
          <div class="pagination-info" *ngIf="commentsPagination.length > 0">
            Affichage de {{commentsPagination.length}} sur {{comments.length}} comments
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="pdf-modal" *ngIf="showPdfViewer ">
  <div class="pdf-modal-content">
    <div class="pdf-modal-header">
      <h3>{{currentPdfName}}</h3>
      <button class="close-btn" (click)="closePdfViewer()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="pdf-viewer-container">
      <iframe class="pdf-viewer" [src]="currentPdfUrl"></iframe>
    </div>
  </div>
</div>
