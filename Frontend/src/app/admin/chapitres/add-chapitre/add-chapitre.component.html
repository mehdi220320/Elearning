<div class="container">
  <div class="form-header">
    <div class="form-icon">
      <i class="fas fa-plus"></i>
    </div>
    <h1 class="form-title">Ajouter un nouveau chapitre</h1>
    <p class="form-subtitle">Complétez les informations pour ce chapitre</p>
  </div>

  <div class="form-card">
    <form id="chapter-form" #addchapitreForm="ngForm" (ngSubmit)="onSubmit(addchapitreForm)">
      <div class="form-group">
        <label for="chapter-title" class="form-label">Titre du chapitre <span>*</span></label>
        <input type="text" id="chapter-title" class="form-control" name="title" [(ngModel)]="title" required placeholder="Ex: Introduction à Python">
      </div>
      <div class="form-group">
        <label for="cours" class="form-label">Cours <span>*</span></label>
        <div class="select-with-add">
          <select id="cours" class="form-control" name="coursId" [(ngModel)]="coursId" required placeholder="Sélectionnez un cours">
            <option value="" disabled >Sélectionnez un cours</option>
            <option *ngFor="let course of courses" [value]="course._id">{{course.title}}</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="chapter-description" class="form-label">Description</label>
        <textarea id="chapter-description" class="form-control" name="description" [(ngModel)]="description"  placeholder="Décrivez le contenu de ce chapitre"></textarea>
      </div>

      <!-- Boucle sur les sections -->
      <div *ngFor="let section of sections; let i = index" class="section-container">
        <div class="section-header">
          <h3>Section {{i + 1}}</h3>
          <button *ngIf="sections.length > 1" type="button" class="btn btn-danger btn-sm" (click)="removeSection(i)">
            <i class="fas fa-trash"></i> Supprimer
          </button>
        </div>

        <div class="form-group">
          <label class="form-label" [for]="'section-title-' + i" >Titre du section <span>*</span></label>
          <input type="text" [id]="'section-title-' + i" class="form-control" [name]="'title-'+i" [(ngModel)]="section.title" required placeholder="Ex: Introduction à Python">
          <label [for]="'section-description-' + i" class="form-label">Description</label>
          <textarea [id]="'section-description-' + i" class="form-control" [name]="'description-'+i" [(ngModel)]="section.description"  placeholder="Décrivez le contenu de ce chapitre"></textarea>

          <label class="form-label mt-1">Type de contenu <span>*</span></label>
          <div class="content-tabs">
            <button
              type="button"
              class="tab-btn"
              [class.active]="section.type === 'video'"
              (click)="changeSectionType(i, 'video')">
              Vidéo
            </button>

            <button
              type="button"
              class="tab-btn"
              [class.active]="section.type === 'pdf'"
              (click)="changeSectionType(i, 'pdf')">
              Ressources
            </button>

            <button
              type="button"
              class="tab-btn"
              [class.active]="section.type === 'both'"
              (click)="changeSectionType(i, 'both')">
              Les deux
            </button>
          </div>

          <!-- Contenu Vidéo -->
          <div class="tab-content" [class.active]="section.type === 'video'">
            <div class="form-group">
              <label [for]="'video-url-' + i" class="form-label">Lien de la vidéo <span>*</span></label>
              <div class="video-input-container">
                <i class="fas fa-link"></i>
                <input
                  type="url"
                  [id]="'video-url-' + i"
                  class="form-control video-input"
                  [name]="'url-' + i"
                  [(ngModel)]="section.url"
                  [required]="section.type === 'video'"
                  placeholder="https://example.com/video">
              </div>
            </div>

            <div class="form-group">
              <label [for]="'video-duration-' + i" class="form-label">Durée de la vidéo</label>
              <div class="duration-input">
                <input
                  type="number"
                  [id]="'video-duration-' + i"
                  class="form-control"
                  min="1"
                  [name]="'duree-' + i"
                  [(ngModel)]="section.duree"
                  [required]="section.type === 'video'"
                  placeholder="15">
                <span class="duration-unit">minutes</span>
              </div>
            </div>
          </div>

          <!-- Contenu PDF -->
          <div class="tab-content" [class.active]="section.type === 'pdf'">
            <div class="form-group">
              <label class="form-label">Fichier <span>*</span></label>
              <div class="file-upload">
                <div class="file-upload-btn">
                  <div class="file-upload-text">
                    <i class="fas fa-file-pdf"></i>
                    <span>Cliquez pour télécharger</span>
                    ou glissez-déposez un fichier "PDF DOC TXT CSV ..."
                    <small>(Max 10MB)</small>
                  </div>

                  <input
                    type="file"
                    class="file-upload-input"
                    [id]="'pdf-file-' + i"
                    [required]="section.type === 'pdf'"
                    (change)="onFileSelected($event, i)"
                    accept=".pdf,.txt,.doc,.docx,.csv,application/pdf,text/plain,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,text/csv">
                </div>
              </div>

              <div class="file-preview" *ngIf="section.selectedFile">
                <i [ngClass]="getFileIconClass(section.selectedFile)" style="font-size: 2.5rem;"></i>
                <div class="file-info">
                  <div class="file-name">{{ section.filename }}</div>
                  <div class="file-size">{{ (section.filesize / 1024).toFixed(2) }} KB</div>
                </div>
                <i class="fas fa-times file-remove" (click)="removeFile(i)"></i>
              </div>
            </div>

            <div class="form-group">
              <label [for]="'page-count-' + i" class="form-label">Nombre de pages</label>
              <input
                type="number"
                [id]="'page-count-' + i"
                class="form-control"
                min="1"
                [name]="'nbpages-' + i"
                [(ngModel)]="section.nbpages"
                [required]="section.type === 'pdf'"
                placeholder="Ex: 12">
            </div>
          </div>

          <!-- Contenu Mixte (Vidéo + PDF) -->
          <div class="tab-content" [class.active]="section.type === 'both'">
            <div class="form-group">
              <label [for]="'both-video-url-' + i" class="form-label">Lien de la vidéo <span>*</span></label>
              <div class="video-input-container">
                <i class="fas fa-link"></i>
                <input
                  type="url"
                  [id]="'both-video-url-' + i"
                  class="form-control video-input"
                  [name]="'url-' + i"
                  [required]="section.type === 'both'"
                  [(ngModel)]="section.url"
                  placeholder="https://example.com/video">
              </div>
            </div>

            <div class="form-group">
              <label [for]="'both-video-duration-' + i" class="form-label">Durée de la vidéo</label>
              <div class="duration-input">
                <input
                  type="number"
                  [id]="'both-video-duration-' + i"
                  class="form-control"
                  [name]="'duree-' + i"
                  [required]="section.type === 'both'"
                  [(ngModel)]="section.duree"
                  min="1"
                  placeholder="15">
                <span class="duration-unit">minutes</span>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Fichier <span>*</span></label>
              <div class="file-upload">
                <div class="file-upload-btn">
                  <div class="file-upload-text">
                    <i class="fas fa-file-pdf"></i>
                    <span>Cliquez pour télécharger</span>
                    ou glissez-déposez un fichier "PDF DOC TXT CSV ..."
                    <small>(Max 10MB)</small>
                  </div>

                  <input
                    type="file"
                    class="file-upload-input"
                    [id]="'both-pdf-file-' + i"
                    [required]="section.type === 'both'"
                    (change)="onFileSelected($event, i)"
                    accept=".pdf,.txt,.doc,.docx,.csv,application/pdf,text/plain,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,text/csv">
                </div>
              </div>

              <div class="file-preview" *ngIf="section.selectedFile">
                <i [ngClass]="getFileIconClass(section.selectedFile)" style="font-size: 2.5rem;"></i>
                <div class="file-info">
                  <div class="file-name">{{ section.filename }}</div>
                  <div class="file-size">{{ (section.filesize / 1024).toFixed(2) }} KB</div>
                </div>
                <i class="fas fa-times file-remove" (click)="removeFile(i)"></i>
              </div>
            </div>

            <div class="form-group">
              <label [for]="'both-page-count-' + i" class="form-label">Nombre de pages</label>
              <input
                type="number"
                [id]="'both-page-count-' + i"
                class="form-control"
                min="1"
                [name]="'nbpages-' + i"
                [required]="section.type === 'both'"
                [(ngModel)]="section.nbpages"
                placeholder="Ex: 12">
            </div>
          </div>
        </div>
      </div>

      <!-- Bouton pour ajouter une nouvelle section -->
      <div class="form-group">
        <button type="button" class="btn btn-outline" (click)="addSection()">
          <i class="fas fa-plus"></i> Ajouter une section
        </button>
      </div>

      <div class="form-group full-width">
        <div class="error-container " *ngIf="error">
          <div class="error-message">
            <i class="fas fa-exclamation-circle"></i>
            {{ error }}
          </div>
        </div>
      </div>

      <div class="form-actions">
        <button type="button" (click)="goBackOrFallback()" class="btn btn-outline">
          <i class="fas fa-times"></i>
          Annuler
        </button>
        <button *ngIf="!isLoading" type="submit" class="btn btn-primary"  [disabled]="addchapitreForm.invalid">
          <i class="fas fa-save"></i>
          Enregistrer le chapitre
        </button>
        <button *ngIf="isLoading" class="btn btn-outline d-flex justify-content-center my-1" style="border: none;font-family: 'Bold Italic Art';font-weight: bold" disabled>
          <span style="margin-right: 10px">Chargement...</span>
          <div class="spinner-border text-primary" role="status">
          </div>
        </button>
      </div>
    </form>
  </div>
</div>
